Array.prototype.getIndex=function(by,value){return this.map(function(item){return String(item[by]);}).indexOf(String(value));};Array.prototype.insert=function(index,item){this.splice(index,0,item);};const RSConfig={container:null,hiddenContainer:null,userId:null,name:null,state:new Object(),perPage:20,width:300,marginRight:10,socketUrl:'http://localhost:8080/',maxWindow:function(){return parseInt(window.innerWidth /(RSConfig.width+RSConfig.marginRight));},beforeDialogOpen:function(){},afterDialogOpen:function(){},defaultTitle:document.getElementsByTagName('title')[0].innerHTML}
RSConfig.container=document.createElement('div');RSConfig.container.className='chat_block_container';document.body.appendChild(RSConfig.container);RSConfig.hiddenContainer=document.createElement('div');RSConfig.hiddenContainer.className='hiddenChat';var a=document.createElement('a');a.className='hdnChtTgl';a.innerHTML='6 Chat More';a.onclick=function(evt){if(hiddenList.style.display=='block'){hiddenList.style.display='none';}else{hiddenList.style.display='block';}};var hiddenList=document.createElement('div');hiddenList.className='dropUp hide';RSConfig.hiddenContainer.appendChild(hiddenList);RSConfig.hiddenContainer.appendChild(a);document.body.appendChild(RSConfig.hiddenContainer);const Storage=function(param){var item=[];var key=param.key;var lsval=localStorage.getItem(key);if(lsval){item=JSON.parse(lsval);}
return{init:function(){lsval=localStorage.getItem(key);if(lsval){item=JSON.parse(lsval);}},reorder:function(){for(var i in RSChat.boxes){}},save:function(value){localStorage.setItem(key,JSON.stringify(value));},add:function(val){var index;if((index=item.getIndex("id",val.id))>-1){item[index].state='opened';this.save(item);}else{item.push(val);this.save(item);}},update:function(id,object){var index;if((index=item.getIndex("id",id))>-1){if(object.hasOwnProperty('state')){item[index].state=object.state;this.save(item);}}},remove:function(id){var index;if((index=item.getIndex("id",id))>-1){item.splice(index,1);this.save(item);}},get:function(key){},getAll:function(key){return item;},count:function(){return item.length;}}};RSConfig.state=new Storage({key:'rsc_popup_state'});RSConfig.state.init();var socket;const RSChat=(function(config){return{boxes:{},init:function(config){RSConfig.userId=config.userId;RSConfig.name=config.name||'';if(config.hasOwnProperty('beforeDialogOpen')){RSConfig.beforeDialogOpen=config.beforeDialogOpen;}
if(config.hasOwnProperty('afterDialogOpen')){RSConfig.afterDialogOpen=config.afterDialogOpen;}
if(config.hasOwnProperty('socketUrl')){RSConfig.socketUrl=config.socketUrl;}
stablishConnection();RSConfig.state.getAll().forEach(function(item){RSChat.start(item.id,item.name,item.state);});},start:function(id,name,state=null){var userId='user_'+id;if(this.boxes.hasOwnProperty(userId)){this.boxes[userId].open();return;}
this.boxes[userId]=new RSChatLayout(id,name);RSConfig.beforeDialogOpen();this.boxes[userId].init('opened');RSChat.reInitWindow();},newMessage:function(data){var userId='user_'+data.userId;this.start(data.userId,data.name);this.boxes[userId].createMsg(data);},remove:function(id){var userId='user_'+id;if(this.boxes.hasOwnProperty(userId)){delete this.boxes[userId];return true;}},reInitWindow:function(){var _=this;var li=null;var marginRight=0;var maxWindow=parseInt((window.innerWidth-100)/(RSConfig.width+RSConfig.marginRight));RSConfig.hiddenContainer.style.display='none';var items=Object.keys(RSChat.boxes).reverse();if(items.length<maxWindow){maxWindow=items.length;}
for(var i=0;i<maxWindow;i++){marginRight=i*(RSConfig.width+RSConfig.marginRight);this.boxes[items[i]].css({marginRight:marginRight+'px',display:"block"});RSConfig.state.update(this.boxes[items[i]].id,{state:'opened'});}
hiddenList.innerHTML='';a.innerHTML=(items.length-maxWindow)+' More Chat';for(var i=maxWindow;i<items.length;i++){this.boxes[items[i]].css({display:"none"});this.boxes[items[i]].state='hidden';RSConfig.state.update(this.boxes[items[i]].id,{state:'hidden'});RSConfig.hiddenContainer.style.display='block';li=document.createElement('a');li.innerHTML=this.boxes[items[i]].name;console.log(items[i]);(function(i){li.onclick=function(){_.boxes[items[i]].open();}})(i);hiddenList.appendChild(li);}},getWindowToReplace:function(){for(var firstKey in this.boxes){if(this.boxes[firstKey].state=='opened')
break;}
return this.boxes[firstKey];}}}());const FriendController=function(friends){this.friends=friends;let friendsHtml='';this.friends.forEach(function(item){friendsHtml+=`<li><a href="#"onclick="RSChat.start('${item.id}', '${item.name}')">${item.name}</a></li>`;document.getElementById('friends').innerHTML=friendsHtml;});};const RSChatLayout=function(id,name){this.id=id;this.name=name;this.lastId=null;this.state='opened';this.loadPrevious=null;this.close=null;this.tpl=null;this.init=function(state){this.state=state;RSConfig.container.appendChild(this.layout());if(state=='opened'){RSConfig.state.add({id:this.id,name:this.name,state:'opened'});}
this.loadPrevious();}
this.chatHolderWrppper=null;this.chatContent=null;this.layout=function(){let _=this;this.tpl=document.createElement('div');this.tpl.className="rs-chat-dialog";this.tpl.innerHTML=`<div class="rs-chat-header primaryColor"><div class="userName colorwhite close-minimize-evt"><i class="fa fa-circle colorgreen text-success"aria-hidden="true"></i>${_.name}</div><div class="rsc-head-toobar colorwhite"><span class="cross icons"></span></div></div><div class="chatHolderWrppper"><div class="chatHolder"><div class="load-previous">Load Previous</div><div class="chat-content"></div></div><div class="chatTextArea"><div style="font-size: 8px !important; position: absolute !important;right: 1px !important;margin-top: 2px !important;display:block !important;">Powered By RS Chat</div><input type="text"placeholder="Type a message..."class="msg_area"></div></div>`;this.loadPreviousBtn=this.tpl.querySelectorAll('.load-previous')[0];this.chatHolderWrppper=this.tpl.querySelectorAll('.chatHolderWrppper')[0];let minWindow=this.tpl.querySelectorAll('.close-minimize-evt');let msgArea=this.tpl.querySelectorAll('.msg_area')[0];this.chatContent=this.tpl.querySelectorAll('.chat-content')[0];this.chatHolder=this.tpl.querySelectorAll('.chatHolder')[0];this.close=this.tpl.querySelectorAll('.rsc-head-toobar')[0].querySelectorAll('.cross')[0];this.close.onclick=function(){RSConfig.state.remove(_.id);_.tpl.remove();RSChat.remove(_.id);RSChat.reInitWindow();}
minWindow[0].onclick=function(){if(_.chatHolderWrppper.style.display=='none'){_.chatHolderWrppper.style.display='block';RSConfig.state.update(_.id,{state:'opened'});return;}
_.chatHolderWrppper.style.display='none';RSConfig.state.update(_.id,{state:'minimize'});}
msgArea.onkeyup=function(evt){if(evt.keyCode==13){let msgObject={userId:RSConfig.userId,toId:_.id,msg:this.value};socket.emit('send',msgObject);_.createMsg(msgObject);this.value='';}};this.loadPreviousBtn.onclick=function(evt){_.loadPrevious();};return this.tpl;}
this.css=(data)=>{if(data.hasOwnProperty('marginRight')){this.tpl.style.marginRight=data.marginRight;}
if(data.hasOwnProperty('display')){this.tpl.style.display=data.display;}}
this.loadPrevious=function(){let _=this;socket.emit('get_history',{toId:_.id,userId:RSConfig.userId,lastId:_.lastId,perPage:RSConfig.perPage},function(data){if(data.messages.length<RSConfig.perPage){_.loadPreviousBtn.style.display='none';}
if(data.messages.length>0){data.messages.forEach(item=>{_.lastId=item.id;_.createPreviousMsg(item);});}});}
this.open=function(){if(this.state=='hidden'){let obj=RSChat.boxes['user_'+this.id];delete RSChat.boxes['user_'+this.id];RSChat.boxes['user_'+this.id]=obj;RSConfig.state.reorder();}
this.chatHolderWrppper.style.display='block';RSConfig.state.add({id:id,name:name,state:'opened'});RSChat.reInitWindow();}
this.createMsg=function(data){this.chatContent.insertAdjacentHTML('beforeend',this.msgTpl(data));this.scrollToBottom();},this.createPreviousMsg=function(data){this.chatContent.insertAdjacentHTML('afterbegin',this.msgTpl(data));this.scrollToBottom();},this.scrollToBottom=function(){this.chatHolder.scrollTop=this.chatHolder.scrollHeight;},this.msgTpl=function(data){if(data.toId==RSConfig.userId){return`<div class="chatRow"><div class="chatL">${data.msg}</div></div>`;}
return`<div class="chatRow"><div class="chatR">${data.msg}</div></div>`;}};function stablishConnection(){socket=io(RSConfig.socketUrl);socket.on('connect',function(msg){socket.emit('createSession',{userId:RSConfig.userId,name:RSConfig.name});});socket.on('history',function(result){result.messages.forEach(msg=>{RSChat.newMessage(msg);})});socket.on('message',function(msg){if(!document.hasFocus()){newTitle('New Message');}
RSChat.newMessage(msg);});}
function newTitle(title){document.title=title;}
window.addEventListener('resize',function(){RSChat.reInitWindow();});window.addEventListener('focus',function(){document.title=RSConfig.defaultTitle;});
